<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript" src="/site_media/jquery/js/jquery-1.6.1.min.js"></script>
     <style type="text/css">
  #formwrap {
   line-height: 2em;
   background: #eef;
   margin: 10px;
   padding: 10px;
   height: 500px;
  }
  body {
   font-family: "Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif;
   font-size: 14px;
  }
  .center { margin-left:auto; margin-right:auto; }
  .help {cursor:help; border-bottom: 1px dotted #A9A9A9}
 </style>

    <script>
        $(function() {
            var reportUrl = '/rundb/api/v1/results/' + TB_result + '/?format=json&noplugin=True';
            $.ajaxSetup({async: false});
            $.get(reportUrl, function (data) {
                referenceID = data.reference;
//                experimentURLPart = data.experiment;
//
//                var experimentUrl = experimentURLPart;
//                    $.ajaxSetup({async: false});
//                    $.get(experimentUrl, function (data) {
//                        targetBed = data.
//
//
//                    });



            });
            $('#referenceid').html(referenceID);
        });

//        function orderSelectorList(selectorID,firstItem) {
//          var lst = $('#'+selectorID+' option');
//          lst.sort(function(a,b) {
//            if( a.text > b.text ) return 1;
//            if( a.text < b.text ) return -1;
//            return 0;
//          });
//          $('#'+selectorID).empty();
//          if( firstItem ) {
//            $('#'+selectorID).append("<option value=''>"+firstItem+"</option>");
//          }
//          $('#'+selectorID).append(lst);
//          if( $('#'+selectorID+' option').size() > 0 )
//            $('#'+selectorID+' option')[0].selected = true;
//        }

//        function populateTargetsList(refID,selectorID,firstItem) {
//          if( selectorID == '' || selectRefs[selectorID] == refID ) return false;
//          selectRefs[selectorID] = refID;
//          $('#'+selectorID).empty();
//          var lstID = selectorID+"@"+refID;
//          if( !selectLst[lstID] ) {
//            var refBedURL = '/rundb/api/v1/content/?format=json&limit=0&publisher__name=BED&path__startswith=/'+refID+refBedType;
//            $.get( refBedURL, function(data) {
//              $.each( data.objects, function(intIndex,result) {
//                var targfile = result.file;
//                var selName = targetNameFromURL(targfile);
//                if( selName != "" && !result.meta.hotspot ) {
//                  $('#'+selectorID).append("<option value='"+targfile+"'>"+selName+"</option>");
//                }
//              });
//            });
//            orderSelectorList(selectorID,firstItem);
//            // ensure reference with no targets get 'none' selection
//            if( $('#'+selectorID+' option').size() == 0 ) {
//              $('#'+selectorID).append("<option value=''>None</option>");
//            }
//            selectLst[lstID] = $('#'+selectorID+' option');
//          } else {
//            $('#'+selectorID).append(selectLst[lstID]);
//            if( $('#'+selectorID+' option').size() > 0 )
//              $('#'+selectorID+' option')[0].selected = true;
//          }
//          $('#targetregions');
//            return true;
//
//        }
//
//        populateTargetsList(referenceID,'targetregions','None');


//        function target_regions_load() {
//        $.get('/rundb/api/v1/content/?format=json&limit=0&publisher__name=BED&path__startswith=/' +
//            current_reference + '/unmerged/detail/&order_by=path', function (data) {
//            $.each(data.objects, function (intIndex, result) {
//                var targfile = result.file;
//                var i = targfile.lastIndexOf('/unmerged/detail/');
//                if (i < 0) return;
//                var bed_filename = targfile.substr(i + 17);
//                var j = bed_filename.lastIndexOf('.bed');
//                if (j <= 0) return;
//                var selName = bed_filename.substr(0, j);
//                if (result.meta.hotspot)
//                    $("#targetloci").append("<option value='" + targfile + "' data-id='" + bed_filename + "'>" + selName + "</option>");
//                else
//                    $("#targetregions").append("<option value='" + targfile + "' data-id='" + bed_filename + "'>" + selName + "</option>");
//            });
//            bed_files_loaded = true;
//        }).fail(function () {});
//}
        $("#postbutton").show();
        $('#postbutton').click(function() {
          obj = $('#coverageAnalysis').serializeObject();
          pluginAPIJSON = { "plugin" : [TB_plugin.fields.name], "pluginconfig" : obj };
          pluginAPIJSON = JSON.stringify(pluginAPIJSON);
          pluginURL = "/rundb/api/v1/results/" + TB_result + "/plugin/";
            console.log(pluginURL);
          $.ajax({
              type: 'POST',
              url: pluginURL,
              async: false,
              contentType: "application/json; charset=utf-8",
              success: function (data) {
                  $("#json_result").html('<div style="text-align: center;"><img src="/site_media/jquery/colorbox/images/loading.gif" alt="Running Plugin" style="float:center"></img><p>Running the Plugin... </p></div>');
                  setTimeout("parent.$.fn.colorbox.close()", 2000);
              },
              data: pluginAPIJSON,
              dataType: "json"
          });
    });

    </script>
</head>

<body>
    <form id="gapsInCoverage" name="gapsInCoverage">
        <div style="text-align:center">
           <h1>Gaps in Coverage Plugin</h1>
        </div>
        <table class="center" cellpadding="5px">
            <tr>
                <td><span class="help" title="Name of the reference genome (or DNA sequences) that the current report was generated against.">Reference Genome:</span></td>
                <td><div id="referenceid"></div></td>
            </tr>
            <tr id="targetselect">
             <td><span class="help"
               title="Select the target regions (ROI) matching your reference and enriched fragment library">
               Targeted Regions:</span></td>
             <td><select id="targetregions" name="targetregions"><option value="">None</option></select></td> </tr>
            <tr id="introncov">
             <td><span class="help"
               title="Specify the minimum number of reads for which a base is considered sufficiently covered. Bases with coverage below this value will be considered 'gaps'">
               Minimum Coverage:</span></td>
             <td><input type="text" size=6 id="minintroncov" name="minintroncov" value=0></select></td> </tr>
            <tr id="exoncheck">
             <td><span class="help"
               title="Check to specify exonic regions">
               Use exonic regions:</span></td>
             <td><input type="checkbox" id="exoncheck" name="exoncheck" value="Yes"/></td> </tr>
            <tr id="exonselect">
             <td><span class="help"
               title="Select a BED file containing the exonic co-ordinates within target regions">
               Exonic Regions:</span></td>
             <td><select id="exonicregions" name="exonicregions"></select></td> </tr>
            <tr id="exoncov">
             <td><span class="help"
               title="Specify the minimum number of reads in exon regions for which a base is considered sufficiently covered. Bases with coverage below this value will be considered 'gaps'">
               Minimum Exon Coverage:</span></td>
             <td><input type="text" size=6 id="minexoncov" name="minexoncov" value=0></select></td> </tr>
        </table>

        <br/>
        <div align="center" id="json_result">
         <input id="postbutton" type="submit" value="Submit" >
        </div>
        <br/>

        <div align="left">
            <h3>Description and Usage Notes</h3>
            <p>
                This plugin generates a list of amplicon bases with coverage below the specified threshold.</p>
            <p>
                Exonic and intronic regions can have different coverage thresholds if an exonic BED file is provided.
            </p>
           </div>
    </form>
</body>
</html>